---
- name: Create a workdir directory if it does not exist
  ansible.builtin.file:
    path: "/home/{{ adguard_home_user }}/adguard-home/workdir/"
    state: directory
    mode: '0755'

- name: Create a confdir directory if it does not exist
  ansible.builtin.file:
    path: "/home/{{ adguard_home_user }}/adguard-home/confdir/"
    state: directory
    mode: '0755'

- name: Install python3 pip
  become: true
  ansible.builtin.apt:
    name: python3-pip

- name: Install python packages
  ansible.builtin.pip:
    name: 
      - docker==6.0.0
      - docker-compose==1.29.2
      - PyYAML

- name: pull adguardhome docker image
  community.docker.docker_image:
    name: adguard/adguardhome
    source: pull
    tag: latest
    # Select platform for pulling. If not specified, will pull whatever docker prefers.
    pull:
      platform: arm64

- name: Template docker-compose file to adguard-home folder
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "/home/{{ adguard_home_user }}/adguard-home/docker-compose.yml"
    owner: "{{ adguard_home_user }}"
    group: "{{ adguard_home_user }}"
    mode: '0644'

- name: Create and start services
  community.docker.docker_compose:
    project_src: /home/{{ adguard_home_user }}/adguard-home/
    state: present
  register: output